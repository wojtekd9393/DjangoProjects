{% extends 'base.html' %}
{% load static %}

{% block navbar %}
        <div id="rinfo" class="retro-info">
            {% if retro.author.id == user.id %}
                <div><span class="retro-name" >{{ retro.name }}</span><i class="fas fa-edit retro-name"></i></div>
            {% else %}
                <div><span class="retro-name-not-author" >{{ retro.name }}</span></div>
            {% endif %}
            <input type="text" class="input-retro-name hidden" value="{{ retro.name }}" onfocus="this.setSelectionRange(this.value.length,this.value.length);">
            <button class="reject hidden"><i class="fas fa-times"></i></button> <button class="accept hidden" data-retro-id="{{ retro.id }}"><i class="fas fa-check"></i></button>
        </div>
{% endblock %}

{% block settings %}
    {% if retro.author.id == user.id %}
        <a class=".dropdown-content" href="{% url 'clear_board' retro.id %}"><i class="fas fa-minus-square"></i> Clear board</a>
    {% endif %}
    {% if retro.voting %}
        <a class=".dropdown-content" href="{% url 'reset_user_votes' retro.id %}"><i class="fas fa-eraser"></i> Reset my votes</a>
    {% endif %}
{% endblock %}

{% block content %}
    <div class="toolbar clearfix">
        <div class="btn-settings">
            <a href="{% url 'settings' retro.id %}"><i class="fas fa-cog"></i>Settings</a>
        </div>
        <div class="search-bar">
            <form method="GET" action="{% url 'home' retro.id %}">
                <input type="text" name="q" placeholder="Search...">
            </form>
        </div>
    </div>

    {% csrf_token %}

    <div id="main-div" class="row">
          <div class="col-sm-4">
              <h4><i class="fas fa-square fa-green"></i> Went Well</h4>
              <div class="card">
                  <div>
                      <p class="card-text">
                          <a class="add-temp-card MainNavText" data-category="1" {% if user.is_authenticated == False or retro.voting or retro.archived %} style="pointer-events: none;" {% endif %}><i class="fas fa-plus-square fa-black fa-2x"></i></a>
                      </p>
                  </div>
              </div>
              <div id="greenList">
                  {% for card in green_cards %}
                    <div class="card text-white bg-success mb-3" data-id="{{ card.id }}">
                        <div class="card-body">
                            <p class="pre-line">{{ card.body }}</p>
                            <div class="actions">
                                {% if user.is_authenticated and card.author.id == user.id and not retro.voting and not retro.archived %}
                                    <i class="fas fa-edit fa-white" data-toggle="tooltip" title="Edit card"></i>
                                    <i class="fas fa-trash-alt fa-white" data-id="{{ card.id }}" data-toggle="tooltip" data-placement="bottom" title="Delete card"></i>
                                {% endif %}
                            </div>
                            {% if retro.voting and user.is_authenticated %}
                                <div class="vote" data-id="{{ card.id }}">
                                    {% if user in card.votes.all %}<i class="fas fa-eraser fa-white" data-id="{{ card.id }}"></i>{% endif %}
                                    <span {% if user in card.votes.all or limit == True %} style="cursor: not-allowed; opacity: 0.5;" {% endif %}><i class="far fa-thumbs-up fa-white" data-id="{{ card.id }}" {% if user in card.votes.all or limit == True %} style="pointer-events: none;" {% endif %}></i></span><p class="bold" style="float: right;">{{ card.get_votes }}</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                  {% endfor %}
              </div>
          </div>

          <div class="col-sm-4">
              <h4><i class="fas fa-square fa-red"></i> To Improve</h4>
              <div class="card">
                  <div>
                      <p class="card-text">
                          <a class="add-temp-card MainNavText" data-category="2" {% if user.is_authenticated == False or retro.voting or retro.archived %} style="pointer-events: none;" {% endif %}><i class="fas fa-plus-square fa-black fa-2x"></i></a>
                      </p>
                  </div>
              </div>
              <div id="redList">
                  {% for card in red_cards %}
                    <div class="card text-white bg-danger mb-3" data-id="{{ card.id }}">
                        <div class="card-body">
                            <p class="pre-line">{{ card.body }}</p>
                            <div class="actions">
                                {% if user.is_authenticated and card.author.id == user.id and not retro.voting and not retro.archived %}
                                    <i class="fas fa-edit fa-white" data-toggle="tooltip" title="Edit card"></i>
                                    <i class="fas fa-trash-alt fa-white" data-id="{{ card.id }}" data-toggle="tooltip" data-placement="bottom" title="Delete card"></i>
                                {% endif %}
                            </div>
                            {% if retro.voting and user.is_authenticated %}
                                <div class="vote" data-id="{{ card.id }}">
                                    {% if user in card.votes.all %}<i class="fas fa-eraser fa-white" data-id="{{ card.id }}"></i>{% endif %}
                                    <span {% if user in card.votes.all or limit == True %} style="cursor: not-allowed; opacity: 0.5;" {% endif %}><i class="far fa-thumbs-up fa-white" data-id="{{ card.id }}" {% if user in card.votes.all or limit == True %} style="pointer-events: none;" {% endif %}></i></span><p class="bold" style="float: right;">{{ card.get_votes }}</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                  {% endfor %}
              </div>
          </div>

          <div class="col-sm-4">
              <h4><i class="fas fa-square fa-blue"></i> Action Points</h4>
              <div class="card">
                  <div>
                      <p class="card-text">
                          <a class="add-temp-card MainNavText" data-category="3" {% if user.is_authenticated == False or retro.voting or retro.archived %} style="pointer-events: none;" {% endif %}><i class="fas fa-plus-square fa-black fa-2x"></i></a>
                      </p>
                  </div>
              </div>
              <div id="blueList">
                  {% for card in blue_cards %}
                    <div class="card text-white bg-primary mb-3" data-id="{{ card.id }}">
                        <div class="card-body">
                            <p class="pre-line">{{ card.body }}</p>
                            <div class="actions">
                                {% if user.is_authenticated and card.author.id == user.id and not retro.voting and not retro.archived %}
                                    <i class="fas fa-edit fa-white" data-toggle="tooltip" title="Edit card"></i>
                                    <i class="fas fa-trash-alt fa-white" data-id="{{ card.id }}" data-toggle="tooltip" data-placement="bottom" title="Delete card"></i>
                                {% endif %}
                            </div>
                            {% if retro.voting and user.is_authenticated %}
                                <div class="vote" data-id="{{ card.id }}">
                                    {% if user in card.votes.all %}<i class="fas fa-eraser fa-white" data-id="{{ card.id }}"></i>{% endif %}
                                    <span {% if user in card.votes.all or limit == True %} style="cursor: not-allowed; opacity: 0.5;" {% endif %}><i class="far fa-thumbs-up fa-white" data-id="{{ card.id }}" {% if user in card.votes.all or limit == True %} style="pointer-events: none;" {% endif %}></i></span><p class="bold" style="float: right;">{{ card.get_votes }}</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                  {% endfor %}
              </div>
          </div>
    </div>

<dialog id="modal-delete">
    <div class="modal-delete-content">
        <div class="modal-delete-icon">
            <i class="fas fa-exclamation-circle"></i>
        </div>
        <h5 id="info">Are you sure you want to delete?</h5>
        <div class="modal-buttons">
            <button class="btn btn-primary" data-id="">Yes, delete it</button>
            <button class="btn btn-secondary">No, keep it</button>
        </div>
    </div>
</dialog>
{% endblock %}

{% block javascript %}
    <script>
        let icons = document.querySelectorAll(".modal_button > i");
        icons.forEach(icon => {
            icon.addEventListener("click", (e) => {
                let category = icon.parentElement.getAttribute("data-category");
                document.getElementsByName("category")[0].value = category;
            });
        })

        const modal = document.getElementById("modal-delete");
        const modal_btn_primary = document.querySelector("#modal-delete button.btn-primary");
        const modal_btn_secondary = document.querySelector("#modal-delete button.btn-secondary");

        let delete_btns = document.querySelectorAll("i.fa-trash-alt");
        delete_btns.forEach(btn => {
            btn.addEventListener("click", (e) => {
                let cardId = btn.getAttribute("data-id");
                modal_btn_primary.setAttribute("data-id", cardId);
                modal.showModal();
            });
        })

        modal_btn_secondary.addEventListener("click", () => {
            modal.close();
        });

        let spanRetroName = document.querySelector("span.retro-name");
        let iconRetroName = document.querySelector("i.retro-name");
        let inputRetroName = document.querySelector("input.input-retro-name");
        let rejectButton = document.querySelector("button.reject");
        let acceptButton = document.querySelector("button.accept");

        [spanRetroName, iconRetroName].forEach(item => {
            item.addEventListener("click", () => {
                spanRetroName.classList.add("hidden");
                iconRetroName.style.display = "none";
                inputRetroName.classList.remove("hidden");
                inputRetroName.value = spanRetroName.innerHTML;
                $(inputRetroName).focus();
                rejectButton.classList.remove("hidden");
                acceptButton.classList.remove("hidden");
            })
        })

        rejectButton.addEventListener("click", () => {
            inputRetroName.classList.add("hidden");
            rejectButton.classList.add("hidden");
            acceptButton.classList.add("hidden");
            spanRetroName.classList.remove("hidden");
            iconRetroName.style.display = "inline-block";
        });

        acceptButton.addEventListener("click", () => {
            inputRetroName.classList.add("hidden");
            rejectButton.classList.add("hidden");
            acceptButton.classList.add("hidden");
            spanRetroName.classList.remove("hidden");
            iconRetroName.style.display = "inline-block";

            let newRetroName = inputRetroName.value != "" ? inputRetroName.value : spanRetroName.innerHTML;
            let retroId = acceptButton.getAttribute("data-retro-id");
            spanRetroName.innerHTML = newRetroName;

            var csrfToken = $("input[name=csrfmiddlewaretoken]").val();

            $.ajax({
                url: '/change_retro_name/' + retroId + '/' + newRetroName,
                data: {
                    csrfmiddlewaretoken: csrfToken
                },
                method: 'POST'
            })
        });
    </script>
    <script type="text/javascript" src="{% static 'js/cards_handling.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/votes_handling.js' %}"></script>
{% endblock %}