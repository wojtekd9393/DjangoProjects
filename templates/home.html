{% extends 'base.html' %}
{% load static %}

    {% block settings %}
        {% if retro.author.id == user.id %}
            <a class=".dropdown-content" href="{% url 'settings' retro.id %}"><i class="fas fa-sliders-h"></i> Board settings</a>
        {% endif %}
    {% endblock %}

{% block content %}
<div class="toolbar">
    {% if retro.author.id == user.id %}
        <div><span class="retro-name" >{{ retro.name }}</span><i class="fas fa-edit retro-name"></i></div>
    {% else %}
        <div><span class="retro-name-not-author" >{{ retro.name }}</span></div>
    {% endif %}
    <input type="text" class="input-retro-name hidden" value="{{ retro.name }}" onfocus="this.setSelectionRange(this.value.length,this.value.length);">
    <button class="reject hidden"><i class="fas fa-times"></i></button> <button class="accept hidden" data-retro-id="{{ retro.id }}"><i class="fas fa-check"></i></button>
</div>

<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Adding card</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
      <form class="form-inline my-2 my-lg-0" id="form" method="post" onkeydown="return event.key != 'Enter';" data-url="{{ request.build_absolute_uri|safe }}">
            {% csrf_token %}
          <input class="form-control mr-sm-2" type="text" placeholder="" aria-label="Search", size="30" name="body">
          <input class="form-control mr-sm-2 add_card"  type="hidden" placeholder="" aria-label="Search", size="30" name="category" value="">
          <input class="form-control mr-sm-2 add_card" type="hidden" placeholder="" aria-label="Search", size="30" name="author" value="{{user.id}}">
          <button class="btn btn-outline-secondary my-2 my-sm-0" type="button" id="createButton">Add Card</button>
      </form>
      </div>
      <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Ten zapis powoduje, ze enterem nie mozna zaakceptowac formularza:
onkeydown="return event.key != 'Enter';"
minus jest taki, ze entera nie mozna tez uzyc w textarea
poprawic w przyszlosci !!!-->
      <div class="row" style="background-color: #e6e6e6;">
          <div class="col-sm-4">
              <h4><i class="fas fa-square fa-green"></i> Went Well</h4>
              <div class="card">
                  <div>
                      <p class="card-text">
                          <a data-target="#exampleModal" data-toggle="modal" class="MainNavText modal_button" id="Modal1" data-category="1"
                            href="#exampleModal" {% if user.is_authenticated == False or retro.voting or retro.archived %} style="pointer-events: none;" {% endif %}><i class="fas fa-plus-square fa-black fa-2x"></i></a>
                      </p>
                  </div>
              </div>
              <div id="greenList">
                  {% for card in green_cards %}
                    <div class="card text-white bg-success mb-3" id="greenCard" data-id="{{ card.id }}">
                        <div class="card-body">
                            <p>{{ card.body }}</p>
                            <div class="actions">
                                {% if user.is_authenticated and card.author.id == user.id and not retro.voting and not retro.archived %}
                                    <a href="{% url 'edit' card.id %}"><i class="fas fa-edit fa-white" data-toggle="tooltip" title="Edit card"></i></a>
                                    <i class="fas fa-trash-alt fa-white" data-id="{{ card.id }}" data-toggle="tooltip" data-placement="bottom" title="Delete card"></i>
                                {% else %}
                                    <a href="{% url 'edit' card.id %}" style="display: none;"><i class="fas fa-edit fa-white"></i></a>
                                    <i class="fas fa-trash-alt fa-white" data-id="{{ card.id }}" data-toggle="tooltip" data-placement="bottom" title="Delete card" style="display: none;"></i>
                                {% endif %}
                            </div>
                            {% if retro.voting and user.is_authenticated %}
                                <div class="vote" data-id="{{ card.id }}">
                                    {% if user in card.votes.all %}<i class="fas fa-eraser fa-white" data-id="{{ card.id }}"></i>{% endif %}
                                    <span {% if user in card.votes.all or limit == True %} style="cursor: not-allowed; opacity: 0.5;" {% endif %}><i class="far fa-thumbs-up fa-white" data-id="{{ card.id }}" {% if user in card.votes.all or limit == True %} style="pointer-events: none;" {% endif %}></i></span><p class="bold" style="float: right;">{{ card.get_votes }}</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                  {% endfor %}
              </div>
          </div>

          <div class="col-sm-4">
              <h4><i class="fas fa-square fa-red"></i> To Improve</h4>
              <div class="card">
                  <div>
                      <p class="card-text">
                          <a data-target="#exampleModal" data-toggle="modal" class="MainNavText modal_button" id="Modal2" data-category="2"
                            href="#exampleModal" {% if user.is_authenticated == False or retro.voting or retro.archived %} style="pointer-events: none;" {% endif %}><i class="fas fa-plus-square fa-black fa-2x"></i></a>
                      </p>
                  </div>
              </div>
              <div id="redList">
                  {% for card in red_cards %}
                    <div class="card text-white bg-danger mb-3" id="redCard" data-id="{{ card.id }}">
                        <div class="card-body">
                            <p>{{ card.body }}</p>
                            <div class="actions">
                                {% if user.is_authenticated and card.author.id == user.id and not retro.voting and not retro.archived %}
                                    <a href="{% url 'edit' card.id %}"><i class="fas fa-edit fa-white" data-toggle="tooltip" title="Edit card"></i></a>
                                    <i class="fas fa-trash-alt fa-white" data-id="{{ card.id }}" data-toggle="tooltip" data-placement="bottom" title="Delete card"></i>
                                {% else %}
                                    <a href="{% url 'edit' card.id %}" style="display: none;"><i class="fas fa-edit fa-white"></i></a>
                                    <i class="fas fa-trash-alt fa-white" data-id="{{ card.id }}" data-toggle="tooltip" data-placement="bottom" title="Delete card" style="display: none;"></i>
                                {% endif %}
                            </div>
                            {% if retro.voting and user.is_authenticated %}
                                <div class="vote" data-id="{{ card.id }}">
                                    {% if user in card.votes.all %}<i class="fas fa-eraser fa-white" data-id="{{ card.id }}"></i>{% endif %}
                                    <span {% if user in card.votes.all or limit == True %} style="cursor: not-allowed; opacity: 0.5;" {% endif %}><i class="far fa-thumbs-up fa-white" data-id="{{ card.id }}" {% if user in card.votes.all or limit == True %} style="pointer-events: none;" {% endif %}></i></span><p class="bold" style="float: right;">{{ card.get_votes }}</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                  {% endfor %}
              </div>
          </div>

          <div class="col-sm-4">
              <h4><i class="fas fa-square fa-blue"></i> Action Points</h4>
              <div class="card">
                  <div>
                      <p class="card-text">
                          <a data-target="#exampleModal" data-toggle="modal" class="MainNavText modal_button" id="Modal3" data-category="3"
                            href="#exampleModal" {% if user.is_authenticated == False or retro.voting or retro.archived %} style="pointer-events: none;" {% endif %}><i class="fas fa-plus-square fa-black fa-2x"></i></a>
                      </p>
                  </div>
              </div>
              <div id="blueList">
                  {% for card in blue_cards %}
                    <div class="card text-white bg-primary mb-3" id="blueCard" data-id="{{ card.id }}">
                        <div class="card-body">
                            <p>{{ card.body }}</p>
                            <div class="actions">
                                {% if user.is_authenticated and card.author.id == user.id and not retro.voting and not retro.archived %}
                                    <a href="{% url 'edit' card.id %}"><i class="fas fa-edit fa-white" data-toggle="tooltip" title="Edit card"></i></a>
                                    <i class="fas fa-trash-alt fa-white" data-id="{{ card.id }}" data-toggle="tooltip" data-placement="bottom" title="Delete card"></i>
                                {% else %}
                                    <a href="{% url 'edit' card.id %}" style="display: none;"><i class="fas fa-edit fa-white"></i></a>
                                    <i class="fas fa-trash-alt fa-white" data-id="{{ card.id }}" data-toggle="tooltip" data-placement="bottom" title="Delete card" style="display: none;"></i>
                                {% endif %}
                            </div>
                            {% if retro.voting and user.is_authenticated %}
                                <div class="vote" data-id="{{ card.id }}">
                                    {% if user in card.votes.all %}<i class="fas fa-eraser fa-white" data-id="{{ card.id }}"></i>{% endif %}
                                    <span {% if user in card.votes.all or limit == True %} style="cursor: not-allowed; opacity: 0.5;" {% endif %}><i class="far fa-thumbs-up fa-white" data-id="{{ card.id }}" {% if user in card.votes.all or limit == True %} style="pointer-events: none;" {% endif %}></i></span><p class="bold" style="float: right;">{{ card.get_votes }}</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                  {% endfor %}
              </div>
          </div>
      </div>

<dialog id="modal-delete">
    <div class="modal-delete-content">
        <div class="modal-delete-icon">
            <i class="fas fa-exclamation-circle"></i>
        </div>
        <h5 id="info">Are you sure you want to delete?</h5>
        <div class="modal-buttons">
            <button class="btn btn-primary" data-id="">Yes, delete it</button>
            <button class="btn btn-secondary">No, keep it</button>
        </div>
    </div>
</dialog>
{% endblock %}

{% block javascript %}
    <script>
        let icons = document.querySelectorAll(".modal_button > i");
        icons.forEach(icon => {
            icon.addEventListener("click", (e) => {
                let category = icon.parentElement.getAttribute("data-category");
                document.getElementsByName("category")[0].value = category;
            });
        })

        const modal = document.getElementById("modal-delete");
        const modal_btn_primary = document.querySelector("#modal-delete button.btn-primary");
        const modal_btn_secondary = document.querySelector("#modal-delete button.btn-secondary");

        let delete_btns = document.querySelectorAll("i.fa-trash-alt");
        delete_btns.forEach(btn => {
            btn.addEventListener("click", (e) => {
                let cardId = btn.getAttribute("data-id");
                modal_btn_primary.setAttribute("data-id", cardId);
                modal.showModal();
            });
        })

        modal_btn_secondary.addEventListener("click", () => {
            modal.close();
        });

        let spanRetroName = document.querySelector("span.retro-name");
        let iconRetroName = document.querySelector("i.retro-name");
        let inputRetroName = document.querySelector("input.input-retro-name");
        let rejectButton = document.querySelector("button.reject");
        let acceptButton = document.querySelector("button.accept");

        [spanRetroName, iconRetroName].forEach(item => {
            item.addEventListener("click", () => {
                spanRetroName.classList.add("hidden");
                iconRetroName.style.display = "none";
                inputRetroName.classList.remove("hidden");
                inputRetroName.value = spanRetroName.innerHTML;
                $(inputRetroName).focus();
                rejectButton.classList.remove("hidden");
                acceptButton.classList.remove("hidden");
            })
        })

        rejectButton.addEventListener("click", () => {
            inputRetroName.classList.add("hidden");
            rejectButton.classList.add("hidden");
            acceptButton.classList.add("hidden");
            spanRetroName.classList.remove("hidden");
            iconRetroName.style.display = "inline-block";
        });

        acceptButton.addEventListener("click", () => {
            inputRetroName.classList.add("hidden");
            rejectButton.classList.add("hidden");
            acceptButton.classList.add("hidden");
            spanRetroName.classList.remove("hidden");
            iconRetroName.style.display = "inline-block";

            let newRetroName = inputRetroName.value != "" ? inputRetroName.value : spanRetroName.innerHTML;
            let retroId = acceptButton.getAttribute("data-retro-id");
            spanRetroName.innerHTML = newRetroName;

            var csrfToken = $("input[name=csrfmiddlewaretoken]").val();

            $.ajax({
                url: '/change_retro_name/' + retroId + '/' + newRetroName,
                data: {
                    csrfmiddlewaretoken: csrfToken
                },
                method: 'POST'
            })
        });
    </script>
    <script type="text/javascript" src="{% static 'js/cards_handling.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/votes_handling.js' %}"></script>
{% endblock %}